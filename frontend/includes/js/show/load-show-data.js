window.LOADED_SONG_ANALYSIS = {
	tempo: 165.246,
	beats: [
		1.09,
		1.44,
		1.8,
		2.14,
		2.49,
		2.87,
		3.21,
		3.6,
		3.95,
		4.3,
		4.65,
		5,
		5.38,
		5.74,
		6.13,
		6.45,
		6.8100000000000005,
		7.2,
		7.5600000000000005,
		7.91,
		8.23,
		8.61,
		8.950000000000001,
		9.32,
		9.7,
		10.08,
		10.39,
		10.75,
		11.14,
		11.5,
		11.85,
		12.21,
		12.56,
		12.93,
		13.3,
		13.67,
		14.01,
		14.370000000000001,
		14.725000000000001,
		15.08,
		15.4,
		15.83,
		16.16,
		16.53,
		16.9,
		17.27,
		17.6,
		17.990000000000002,
		18.330000000000002,
		18.67,
		19.045,
		19.42,
		19.73,
		20.09,
		20.42,
		20.795,
		21.17,
		21.57,
		21.89,
		22.31,
		22.64,
		23.01,
		23.380000000000003,
		23.75,
		24.09,
		24.445,
		24.8,
		25.14,
		25.5,
		25.84,
		26.22,
		26.57,
		26.93,
		27.29,
		27.68,
		28.01,
		28.36,
		28.740000000000002,
		29.080000000000002,
		29.400000000000002,
		29.8,
		30.12,
		30.47,
		30.82,
		31.26,
		31.580000000000002,
		31.96,
		32.34,
		32.68,
		33.03,
		33.38,
		33.730000000000004,
		34.08,
		34.44,
		34.81,
		35.17,
		35.53,
		35.88,
		36.230000000000004,
		36.67,
		37.04,
		37.4,
		37.76,
		38.11,
		38.5,
		38.83,
		39.17,
		39.52,
		39.86,
		40.22,
		40.58,
		41,
		41.32,
		41.67,
		42.03,
		42.44,
		42.79,
		43.160000000000004,
		43.47,
		43.87,
		44.21,
		44.550000000000004,
		44.910000000000004,
		45.27,
		45.63,
		45.985,
		46.34,
		46.72,
		47.12,
		47.480000000000004,
		47.85,
		48.2,
		48.57,
		48.94,
		49.26,
		49.67,
		49.99,
		50.31,
		50.660000000000004,
		51.07,
		51.44,
		51.77,
		52.160000000000004,
		52.495000000000005,
		52.83,
		53.21,
		53.54,
		53.94,
		54.34,
		54.69,
		55.03,
		55.370000000000005,
		55.72,
		56.08,
		56.44,
		56.79,
		57.2,
		57.550000000000004,
		57.86,
		58.230000000000004,
		58.56,
		58.96,
		59.31,
		59.660000000000004,
		60.04,
		60.38333333333333,
		60.72666666666667,
		61.07,
		61.445,
		61.82,
		62.190000000000005,
		62.54,
		62.894999999999996,
		63.25,
		63.59,
		63.940000000000005,
		64.3,
		64.7,
		65.06,
		65.4,
		65.77000000000001,
		66.14,
		66.47,
		66.82000000000001,
		67.16,
		67.56,
		67.95,
		68.32000000000001,
		68.66,
		69,
		69.42,
		69.76,
		70.13,
		70.48,
		70.81,
		71.2,
		71.56,
		71.92,
		72.3,
		72.65,
		73,
		73.34,
		73.67,
		74.07000000000001,
		74.39,
		74.76,
		75.11,
		75.48,
		75.87,
		76.22,
		76.58,
		76.93,
		77.3,
		77.65,
		78,
		78.38,
		78.74,
		79.08,
		79.45,
		79.78,
		80.17,
		80.51,
		80.9,
		81.29,
		81.60000000000001,
		81.99,
		82.34,
		82.71000000000001,
		83.07000000000001,
		83.42,
		83.78,
		84.15,
		84.48,
		84.85000000000001,
		85.24,
		85.57000000000001,
		85.93,
		86.29,
		86.66,
		87,
		87.33,
		87.76,
		88.11,
		88.46000000000001,
		88.81,
		89.21000000000001,
		89.57000000000001,
		89.9,
		90.29,
		90.63,
		91,
		91.37,
		91.73500000000001,
		92.10000000000001,
		92.55,
		92.99,
		93.4,
		93.775,
		94.15,
		94.50750000000001,
		94.86500000000001,
		95.22250000000001,
		95.58,
		95.965,
		96.35000000000001,
		96.7,
		97.055,
		97.41,
		97.73,
		98.14,
		98.54,
		98.86,
		99.26,
		99.605,
		99.95,
		100.3,
		100.71000000000001,
		101.04,
		101.41,
		101.75999999999999,
		102.11,
		102.45,
		102.81,
		103.17,
		103.53,
		103.89,
		104.29,
		104.66,
		105.03,
		105.39,
		105.75,
		106.105,
		106.46000000000001,
		106.82000000000001,
		107.16,
		107.49000000000001,
		107.85000000000001,
		108.21000000000001,
		108.57000000000001,
		108.93,
		109.31,
		109.67,
		110.03,
		110.37,
		110.73,
		111.09,
		111.49000000000001,
		111.81,
		112.2,
		112.53,
		112.92,
		113.24000000000001,
		113.64,
		114.01,
		114.33,
		114.69,
		115.05,
		115.41,
		115.76,
		116.14,
		116.52,
		116.86,
		117.2,
		117.55,
		117.92,
		118.28,
		118.66,
		119.02,
		119.39,
		119.72,
		120.04,
		120.48,
		120.79,
		121.15,
		121.52,
		121.89,
		122.29,
		122.61,
		122.98,
		123.37,
		123.72,
		124.09,
		124.44,
		124.79,
		125.15,
		125.5,
		125.85000000000001,
		126.2,
		126.57000000000001,
		126.91,
		127.32000000000001,
		127.65,
		128.03,
		128.37,
		128.7,
		129.06,
		129.43,
		129.78,
		130.17000000000002,
		130.48,
		130.92000000000002,
		131.25,
		131.64000000000001,
		132,
		132.37,
		132.71,
		133.02,
		133.42000000000002,
		133.78,
		134.135,
		134.49,
		134.87,
		135.25,
		135.64000000000001,
		135.96,
		136.27,
		136.67000000000002,
		136.99,
		137.36,
		137.70000000000002,
		138.08,
		138.41,
		138.82,
		139.17000000000002,
		139.49,
		139.83,
		140.22,
		140.58,
		140.9,
		141.25,
		141.66,
		142.01,
		142.38,
		142.70000000000002,
		143.1,
		143.45000000000002,
		143.81,
		144.15,
		144.56,
		144.91,
		145.26,
		145.61,
		146,
		146.32,
		146.72,
		147.08,
		147.44,
		147.81,
		148.14000000000001,
		148.5,
		148.86,
		149.21,
		149.58,
		149.95000000000002,
		150.31,
		150.67000000000002,
		151.01,
		151.4,
		151.74,
		152.1,
		152.44,
		152.8,
		153.17000000000002,
		153.53,
		153.86,
		154.24,
		154.62,
		154.93,
		155.35,
		155.70000000000002,
		156.05,
		156.41,
		156.78,
		157.12,
		157.48,
		157.84,
		158.22,
		158.6,
		158.92000000000002,
		159.31,
		159.65,
		160.01,
		160.37,
		160.72,
		161.07,
		161.48,
		161.8,
		162.14000000000001,
		162.505,
		162.87,
		163.25,
		163.6,
		163.93,
		164.29333333333335,
		164.6566666666667,
		165.02,
		165.39000000000001,
		165.75,
		166.11,
		166.46,
		166.81,
		167.17000000000002,
		167.59,
		167.95,
		168.31,
		168.67000000000002,
		169.03,
		169.35,
		169.76,
		170.08,
		170.5,
		170.845,
		171.19,
		171.54,
		171.89000000000001,
		172.23,
		172.63,
		172.97,
		173.315,
		173.66,
		174.02,
		174.41,
		174.8,
		175.15,
		175.49,
		175.84,
		176.20000000000002,
		176.555,
		176.91,
		177.26,
		177.65,
		178.02,
		178.36,
		178.71,
		179.06,
		179.42000000000002,
		179.78,
		180.15,
		180.5,
		180.91,
		181.26,
		181.67000000000002,
		182.08,
		182.42000000000002,
		182.8,
		183.17000000000002,
		183.55,
		183.905,
		184.26,
		184.62,
		184.985,
		185.35,
		185.66,
		186.08,
		186.45000000000002,
		186.82,
		187.20000000000002,
		187.56
	]
}


const params = new URLSearchParams(location.search);
window.SHOW_ID = params.get('show');
window.SHOW_VERSION = params.get('version');
if(window.SHOW_VERSION === null || window.SHOW_VERSION.length === 0) {
	window.SHOW_VERSION = new Date().getTime();
	params.set('version', window.SHOW_VERSION);
	window.history.replaceState({}, '', `${location.pathname}?${params.toString()}`);
}

async function loadShowData() {
	await new Promise(function (resolve, reject, returned = 0) {
		tired.xhr.get("/metadata?show=" + window.SHOW_ID, function (err, response, status) {
			if (status === 200) window.SHOW_META = JSON.parse(response);

			returned++;
			if (returned === 3) resolve();
		});
		tired.xhr.get(`/instructions?show=${window.SHOW_ID}&version=${window.SHOW_VERSION}`, function (err, response, status) {
			if (status === 200) window.SHOW_INSTRUCTIONS = response
			else window.SHOW_INSTRUCTIONS = {};

			returned++;
			if (returned === 3) resolve();
		});
		window.LOADED_AUDIO_FILE = new Audio("/mp3?show=" + window.SHOW_ID);
		window.LOADED_AUDIO_FILE.addEventListener('loadeddata', () => {
			window.audio = new AudioManager(window.LOADED_AUDIO_FILE);
			window.AnimationManager.addRenderCallback(window.audio.render.bind(window.audio));

			returned++;
			if (returned === 3) resolve();
		});
	});

	for(const LASER_DESIGN_KEY in window.LASER_DESIGNS){
		const LASER_DESIGN = window.LASER_DESIGNS[LASER_DESIGN_KEY];
		console.log(LASER_DESIGN);
		window.laserDisplay.registerDesign(LASER_DESIGN_KEY, LASER_DESIGN[0], LASER_DESIGN[1]);
	}

	window.timeline.SONG = JSON.parse(JSON.stringify(window.SHOW_META));
	window.timeline.SONG.duration = window.audio.getDuration();
	window.timeline.SONG.instructions = JSON.parse(window.SHOW_INSTRUCTIONS);

	window.timeline.SONG.tempo = parseFloat(window.LOADED_SONG_ANALYSIS.tempo);
	window.timeline.SONG.beats = window.LOADED_SONG_ANALYSIS.beats;

	initTimeline();

	window.timeline.loadFromInstructions(JSON.parse(window.SHOW_INSTRUCTIONS));
}
loadShowData();